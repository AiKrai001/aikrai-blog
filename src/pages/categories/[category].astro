---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { SITE_TITLE } from '../../consts';
import { decodePathSegmentSafe, encodePathSegmentSafe } from '../../utils/safeSlug';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const categories = new Set<string>();
  
  posts.forEach(post => {
    const postCategories = post.data.categories || [];
    postCategories.forEach(category => categories.add(category));
  });

  return Array.from(categories).map(category => ({
    params: { category: encodePathSegmentSafe(category) },
    props: { category }
  }));
}

const { category } = Astro.props as { category: string };
// 从URL参数中获取分类名（安全解码）
const categoryParam = Astro.params.category as string;
const decodedCategory = categoryParam ? decodePathSegmentSafe(categoryParam) : category;

const posts = (await getCollection('blog')).filter(post => 
  post.data.categories && post.data.categories.includes(decodedCategory)
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title={`分类: ${decodedCategory} - ${SITE_TITLE}`} description={`分类 ${decodedCategory} 下的所有文章`}>
  <div class="category-page-container">
    <header class="page-header">
      <div class="category-info">
        <div class="category-icon">
          <i class="far fa-folder"></i>
        </div>
        <div>
          <h1>{decodedCategory}</h1>
          <p>{posts.length} 篇文章</p>
        </div>
      </div>
      
    </header>

    <div class="posts-section">
      <div class="posts-grid">
        {posts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>

      {posts.length === 0 && (
        <div class="empty-state">
          <i class="far fa-folder-open"></i>
          <p>该分类下暂无文章</p>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  .category-page-container {
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 0 var(--spacing-4);
  }

  .page-header {
    margin-bottom: var(--spacing-8);
  }

  .category-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-4);
  }

  .category-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    background-color: var(--primary-color);
    color: white;
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-xl);
  }

  .category-info h1 {
    margin: 0;
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-color);
  }

  .category-info p {
    margin: 0;
    font-size: var(--font-size-lg);
    color: var(--text-muted);
  }

  

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--spacing-6);
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-12) var(--spacing-4);
    color: var(--text-muted);
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: var(--spacing-4);
    opacity: 0.5;
  }

  .empty-state p {
    font-size: var(--font-size-lg);
    margin: 0;
  }

  /* 响应式设置 */
  @media (max-width: 768px) {
    .category-info {
      flex-direction: column;
      text-align: center;
      gap: var(--spacing-3);
    }

    .category-info h1 {
      font-size: var(--font-size-2xl);
    }

    .posts-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-4);
    }

    
  }
</style>

